---
title: "Flowcytometry_preprocessing"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
author: "F.M. Kerckhof"
date: "`r Sys.Date()`"
output: 
  html_document: 
    code_folding: show
    highlight: zenburn
    keep_md: yes
    theme: cosmo
    toc: yes
    number_sections: true
    toc_float:
      collapsed: no
      smooth_scroll: yes
      toc_depth: 4
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
### Set knitr options ----------------------------------------------------------
knitr::opts_chunk$set(echo = TRUE)
### load required packages -----------------------------------------------------
library(Phenoflow)
library(knitr)
library(kableExtra)
library(forecast)
library(tsoutliers)
library(flowWorkspace)
library(ggcyto)
library(scales)
library(officer)
library(tidyverse)
library(openCyto)
library(openxlsx)
library(data.table)

### Custom functions -----------------------------------------------------------

iccplotr<-function(x){
  pICCgatetemp <- ggcyto(x,aes(x="BL1-H",y="BL3-H"))
  pICCgatetemp <- pICCgatetemp + geom_hex(bins=512) + theme_bw() + labs_cyto("marker")+ ggcyto_par_set(limits="instrument")+
            geom_gate(polyGateICC,colour="darkgreen") + geom_gate(polyGateDCC,colour="darkred")
  print(pICCgatetemp)
}

tccplotr<-function(x){
  pTCCgatetemp <- ggcyto(x,aes(x="BL1-H",y="BL3-H"))
  pTCCgatetemp <- pTCCgatetemp + geom_hex(bins=512) + theme_bw() + labs_cyto("marker")+ ggcyto_par_set(limits="instrument")+
            geom_gate(polyGateTCC,colour="darkgreen") 
  print(pTCCgatetemp)
}

syprosytoplotr<-function(x){
  pSYPROSYTOgatetemp <- ggcyto(x,aes(x="RL1-H",y="BL2-H"))
  pSYPROSYTOgatetemp <- pSYPROSYTOgatetemp + geom_hex(bins=256) + theme_bw() + labs_cyto("marker")+
                        ggcyto_par_set(limits="data")+
                        geom_gate(polyGateSYPROSYTO,colour="orangered") 
  print(pSYPROSYTOgatetemp)
}

syprosscplotr<-function(x){
  pSYPROSSCgatetemp <- ggcyto(x,aes(x="SSC-H",y="BL2-H"))
  pSYPROSSCgatetemp <- pSYPROSSCgatetemp + geom_hex(bins=256) + theme_bw() + labs_cyto("marker")+
            ggcyto_par_set(limits="data")+
            geom_gate(polyGateSYPROSSC,colour="darkgreen") 
  print(pSYPROSSCgatetemp)
}

singletplotr<-function(x){
  psingletgatetemp <- ggcyto(x,aes(x="BL1-H",y="BL1-A"))
  psingletgatetemp <- psingletgatetemp + geom_hex(bins=256) + theme_bw() + labs_cyto("marker")+
            ggcyto_par_set(limits="data")+
            geom_gate(polyGatesinglets,colour="darkgreen") 
  print(psingletgatetemp)
}

### load raw data --------------------------------------------------------------

# PLEASE NOTE:
# currently, because of github file storage limitations, first the raw data files 
# files will need to be donwloaded from the flowRepository (ID FR-FCM-Z6Y6)
# and placed into Source_data. The KP panels should be saved under fcsfiles_KP
# and the other panels under fcsfiles_CNEC.

#### KP raw data ---------------------------------------------------------------
allfs.orig <- read.flowSet(path="Source_data/fcsfiles_KP/",pattern="*.fcs",
                           emptyValue = FALSE)
#### CNEC raw data -------------------------------------------------------------
mainflowset <- read.flowSet(path="Source_data/fcsfiles_CNEC/",pattern="*.fcs",
                                   emptyValue = FALSE)

### load metadata --------------------------------------------------------------

#### KP metadata and annotation ------------------------------------------------
metadata_all <- readxl::read_xlsx("alexandra_meta.xlsx",sheet="to_verify")
cordillstert <- readxl::read_xlsx("Alexandra_ICC_dils_corr.xlsx",sheet=1)

#experiment 1 KP was wrongly excluded
KPexp1names <- metadata_all %>%
  dplyr::filter(target == "PROTEIN" &
                  strain == "KP" &
                  Replicateno == 1) %>%
  pull(filenames)

metadata_all[metadata_all$filenames%in%KPexp1names,]$`Toanalyze?`<-"Yes"

#### CNEC metadata and annotation ----------------------------------------------
metadatadf <- readxl::read_xlsx("Metadata_Myrsini_main_run_MS.xlsx")
metadatadf$cumtim <- as.numeric(gsub("t","",metadatadf$Timepoint))*2L

### data wrangling -------------------------------------------------------------
mddf.toanalyze <- metadata_all %>% dplyr::filter(`Toanalyze?`!="No")
mddf.toanalyze$experiment <- "exp1"
mddf.toanalyze$experiment[grep("exp2",mddf.toanalyze$filenames)] <- "exp2"
mddf.toanalyze$experiment[grep("EXP2",mddf.toanalyze$filenames)] <- "exp2"
mddf.toanalyze$experiment[grep("exp3",mddf.toanalyze$filenames)] <- "exp3"
mddf.toanalyze$experiment[grep("EXP3",mddf.toanalyze$filenames)] <- "exp3"
# mddf.toanalyze$filenames %in% sampleNames(allfs.orig) # all good


### pre-transform FCM data for KP ----------------------------------------------

trans.func <- asinh
inv.func <- sinh
trans.obj <- trans_new("myAsinh", trans.func, inv.func)
chnls <- colnames(allfs.orig)[2:28]
transList <- transformerList(chnls,trans.obj)
gsall <- GatingSet(allfs.orig)
gsall <- transform(gsall, transList)
allfs_transformed <- cytoset_to_flowSet(gs_pop_get_data(gsall))

```

# Introduction

  
# Methods

## FCM 

### Acquisition

Data was acquired on a Thermo Scientific Attune NXT 2019 (BRxx configuration: 488nm (blue/BL) laser and 635nm (red/RL) laser). For elementary data processing, gates were set based upon certain (single-stained ) controls. Acquisition was performed at a flowrate of 100µL/min and event rates were kept below 8000 events/second (although, due to high background some BODIPY samples reached 10.000 eps) by diluting in phosphate buffered saline (Sigma). Acquisition was stopped after 75µL of volume was recorded. An initial lead-time of 15 seconds was not recorded in order to stabilize the flow.

Total cell concentration and intact cell concentration were determined by staining with SYBR Green I and SYBR Green I/Propidium Iodide respectively, as outlined in CMET SOP OPT-001. The threshold is the green fluorescence in the BL1 (530/30BP) channel. SYBR Green I was detected on BL1 (530/30BP) while propidium iodide was detected on BL3 (695/40BP).

Using the Thermo SYTO red stain sampler kit, we assessed staining efficiency and stability for SYTO60, SYTO61 and SYTO62, and decided that SYTO62 offered the best trade-off between low noise and stain stability. In assays for BODIPY and SYPRO orange, a triple-threshold was used with a (low) SSC-H threshold, followed by an appropriate threshold on the SYTO62 fluorescence (RL1:670/14BP) and a minor threshold on the fluorescence of BODIPY 493/503 (BL1:530/30BP) or SYPRO orange (BL2:574/26BP).

The events and fluorescence over time stability was closely monitored for acquisition-level stability.

### Data processing

In a simple approach, we used fluorescence gates to determine ICC, TCC and DCC
through time. In order to assure proper acquisition only singlets (in A/H plots
of main fluorescent parameter - in this case BL1) were counted. 

All cultures were executed in quadruplicate - we applied three modes of outlier 
detection and removal, to assure more consistent results:

  1. Manual removal (MS Excel) - based on IQR cutoff - whole sample is removed when flagged as outlier
  2. Time-series based outlier removal (R package `tsoutlier`) - whole sample is removed when flagged as outlier
  3. flowAI based event-level QC (R package `flowAI`)- based on dynamic range and fluorescence stability - only aberrant events are removed (only executed on SYPRO/BODIPY data as they could affect MFI's - if fingerprinting is executed at a later stage this or flowCut will be done as well on SG data)
  

# Results

## (Intact) cell counts

### K. phaffii

#### Data quality and acquisition-level cleanup

Based upon visual inspection of the relevant gates, re-acquisition of certain
samples was performed. Below we use flowAI (Monaco *et al.*, 2016) to cleanup
acquisition-level problems in the data. First, however, we need to identify only
the cellular population based upon gates.

##### Singlet gating {.tabset .tabset-pills}

Because of the documented tendency of KP to aggregate, we first made sure
that only "singlet" events were considered. We can observe that the fraction of
singlet to total events *roughly* decreases over time in MMMV. 


```{r singletgating, warning=FALSE,message=FALSE,fig.cap="Fraction of singlet events in MMMV over time (colored by strain or combination). KP= Komagataella pastoris",cache=TRUE,cache.lazy=FALSE}
# Subset to only ICC -----------------------------------------------------------
mddf.toanalyze.ICC.MMMV <- mddf.toanalyze %>% 
                              dplyr::filter(target=="ICC"&Medium=="MMMV")

gsICCMMMV <- gsall[mddf.toanalyze.ICC.MMMV$filenames]

fsICCMMMV <- allfs_transformed[mddf.toanalyze.ICC.MMMV$filenames]
# unique(fsApply(fsICCMMMV,function(x)x@description$`$P12V`))
# unique(fsApply(fsICCMMMV,function(x)x@description$`$P11V`))
# unique(fsApply(fsICCMMMV,function(x)x@description$`$P13V`))
# unique(fsApply(fsICCMMMV,function(x)x@description$`$P15V`))

# Design gates -----------------------------------------------------------------

## Yeast gates -----------------------------------------------------------------
sqrcutICCyeast<- matrix(c(11.0, 11.0, 14.5, 14.5,
                          6.50, 8.50, 12.0, 11.0),
     ncol = 2,
     nrow = 4)
colnames(sqrcutICCyeast) <- c("BL1-H", "BL3-H")
polyGateICCyeast <- polygonGate(.gate = sqrcutICCyeast, 
                                filterId = "Intact Yeast Cells")

sqrcutICCyeastprim<- matrix(c(9.25, 9.50, 14.5, 14.5,
                              5.00, 8.60, 13.0, 11.0),
     ncol = 2,
     nrow = 4)
colnames(sqrcutICCyeastprim) <- c("BL1-H", "BL3-H")
polyGateICCyeastprim <- polygonGate(.gate = sqrcutICCyeastprim, 
                                filterId = "Intact Yeast Cells (primary)")

sqrcutICCyeastSC<- matrix(c(10.0, 15.0, 15.0,  15.0, 10.0,
                            7.10, 7.65, 11.5,  15.0, 10.2),
     ncol = 2,
     nrow = 5)
colnames(sqrcutICCyeastSC) <- c("BL1-H", "SSC-H")
polyGateICCyeastSC <- polygonGate(.gate = sqrcutICCyeastSC, 
                                filterId = "Yeast Cells scatter")

sqrcutICCyeastSCprim<- matrix(c(10.5, 15.0, 15.0,  15.0, 12.5,
                                6.75, 7.65, 11.5,  12.5, 10.0),
     ncol = 2,
     nrow = 5)
colnames(sqrcutICCyeastSCprim) <- c("BL1-H", "SSC-H")
polyGateICCyeastSCprim <- polygonGate(.gate = sqrcutICCyeastSCprim, 
                                filterId = "Yeast Cells BL1/SSC")

sqrcutICCyeastSConly<- matrix(c(9.70, 12.0, 13.5,  13.65, 12.0,9.3,
                                6.10, 7.60, 10.0,  12.65, 10.2,7.6),
                              ncol = 2,
                              nrow = 6)
colnames(sqrcutICCyeastSConly) <- c("FSC-H", "SSC-H")
polyGateICCyeastSConly <- polygonGate(.gate = sqrcutICCyeastSConly, 
                                filterId = "Yeast Cells scatter alone")
## DCC gate --------------------------------------------------------------------
sqrcutDCC<- matrix(c(11.0, 11.0, 14.5, 14.5,
                     9.00, 13.0, 15.0, 12.0),
     ncol = 2,
     nrow = 4)
colnames(sqrcutDCC) <- c("BL1-H", "BL3-H")
polyGateDCC <- polygonGate(.gate = sqrcutDCC, filterId = "Damaged Cells")

sqrcutDCCprim<- matrix(c(8.00, 8.00, 13.5, 13.5,
                         7.00, 13.0, 15.0, 12.5),
     ncol = 2,
     nrow = 4)
colnames(sqrcutDCCprim) <- c("BL1-H", "BL3-H")
polyGateDCCprim <- polygonGate(.gate = sqrcutDCCprim,
                               filterId = "Damaged Cells (primary)")


## Singlet gate ----------------------------------------------------------------
sqrcutsinglets<- matrix(c(6.0, 14.5, 14.5, 6.0,
                          5.5, 14.3, 15.1, 6.2),
     ncol = 2,
     nrow = 4)
colnames(sqrcutsinglets) <- c("BL1-H", "BL1-A")
polyGatesinglets <- polygonGate(.gate = sqrcutsinglets, filterId = "Singlets")

# Add nodes to GS --------------------------------------------------------------

nodesinglets <- gs_pop_add(gsICCMMMV,polyGatesinglets)


recompute(gsICCMMMV)
selset <- gsICCMMMV[sample(1:length(gsICCMMMV),9)]

selset.yeast.iccmmmv <- gsICCMMMV[grep("KP_10",sampleNames(gsICCMMMV),
                                       value = TRUE)[c(1:13,15:29)]]

node2 <- gs_pop_add(gsICCMMMV,polyGateICCyeastSConly,parent="Singlets")

recompute(gsICCMMMV)

recompute(selset.yeast.iccmmmv)

# Optional: below you can inspect the (hierarchical) gating strategy
# plot(selset.yeast.iccmmmv)


# Get singlet stats and visualize ----------------------------------------------
singletfraction <- gs_pop_get_count_fast(gsICCMMMV,statistic = "freq",
                                         subpopulations = "/Singlets")
singletfraction.md <- inner_join(singletfraction,mddf.toanalyze,
                                 by=c("name"="filenames"))
singletfraction.md$timepoint <- gsub(".*Alexandra_(t[0-9])_.*","\\1",
                                     singletfraction.md$name)
singletfraction.md$timepointnum <- as.numeric(gsub("t","",
                                              singletfraction.md$timepoint))
wbsglets <- openxlsx::createWorkbook(title="Alexandra singlets MMMV")
openxlsx::addWorksheet(wbsglets,sheetName="MMMV_singletFraction")
openxlsx::writeData(wbsglets,sheet="MMMV_singletFraction",x = singletfraction.md)

# splot <- singletfraction.md %>% ggplot(aes(x=timepointnum,y=Frequency,
#                                            color=strain,fill=strain))
# splot + geom_point(size=4) + geom_smooth(se=0.5) + theme_bw()

splotbp <- singletfraction.md %>% ggplot(aes(x=timepoint,y=Frequency,
                                             fill=strain))
splotbp + geom_boxplot() + theme_bw() + facet_wrap(~strain,scale="free_y") +
          ylab("Fraction of singlets/total events") + 
          scale_fill_brewer(name="Strain or\ncombination",palette = "Dark2") +
          theme(axis.title.x = element_blank())

openxlsx::saveWorkbook(wbsglets,
                       file="Results/SingletFraction.xlsx",
                       overwrite = TRUE)
```


For reference, we display 6 random samples for each singlet gating set. Clearly,
a lot of non-singlets could be observed for KP in MMMV

```{r KPsingletinspection, warning=FALSE,message=FALSE,fig.cap="6 randomly selected samples to demonstrate singlet gating for KP",cache=TRUE, cache.lazy=FALSE}
pICCMMVsing <- selset.yeast.iccmmmv[sample(1:length(selset.yeast.iccmmmv),6)] %>%
                      ggcyto(aes(x=`BL1-A`,y=`BL1-H`),subset="root")
pICCMMVsing + geom_hex(bins=256) + theme_bw() + geom_gate(polyGatesinglets)
```



##### Scater/fluorescence gating strategy {.tabset .tabset-pills}

###### Primary gating on scatter alone 


```{r ICCTCCgs_MMMV, echo=FALSE,warning=FALSE,message=FALSE,fig.cap="Example gating strategy for KP in MMMV based on primary gating for scatter alone.",cache=TRUE,cache.lazy=FALSE}
# Verify gating strategy for yeast, yeast, ICC, MMMMV---------------------------
pICCMMVsco <- selset.yeast.iccmmmv[sample(1:length(selset.yeast.iccmmmv),9)] %>% 
                      ggcyto(aes(x=`SSC-H`,y=`FSC-H`),subset="Singlets")
pICCMMVsco + geom_hex(bins=256) + theme_bw() + 
  geom_gate(polyGateICCyeastSConly) + ggcyto_par_set(limits="instrument")


# use officer for slides -------------------------------------------------------
yeastscatterslides <- read_pptx()
yeastscatterslides <- add_slide(yeastscatterslides,layout = "Title Slide",
                                master = "Office Theme")
# layout_properties(yeastscatterslides,layout = "Title Slide")
yeastscatterslides <- ph_with(yeastscatterslides,
                              value="Gating manual verification slides",
                              location=ph_location_type(type="ctrTitle"))
yeastscatterslides <- ph_with(yeastscatterslides,
                              value="For check by Myrsini and Alexandra",
                              location=ph_location_type(type="subTitle"))
yeastscatterslides <- ph_with(yeastscatterslides, 
                              value = format(Sys.Date()), 
                              location = ph_location_type(type = "dt"))
yeastscatterslides <- ph_with(yeastscatterslides, value = "slide 1", 
                              location = ph_location_type(type = "sldNum"))

yeastscatterslides <- add_slide(yeastscatterslides,layout = "Section Header",
                                master = "Office Theme")

yeastscatterslides <- ph_with(yeastscatterslides,
                              value="Scatter-based primary gating for yeast MMMV",
                              location=ph_location_type(type="title"))
yeastscatterslides <- ph_with(yeastscatterslides, 
                              value = format(Sys.Date()), 
                              location = ph_location_type(type = "dt"))
yeastscatterslides <- ph_with(yeastscatterslides, value = "slide 2", 
                              location = ph_location_type(type = "sldNum"))
### yeast scatter only ---------------------------------------------------------
for(i in 1:length(selset.yeast.iccmmmv)){
  yeastscatterslides <- add_slide(yeastscatterslides,
                                  layout = "Title and Content",
                                  master = "Office Theme")
  yeastscatterslides <- ph_with(yeastscatterslides, 
                              value = format(Sys.Date()), 
                              location = ph_location_type(type = "dt"))
  yeastscatterslides <- ph_with(yeastscatterslides, 
                                value = paste0("slide ",i+2), 
                              location = ph_location_type(type = "sldNum"))
  piccmmmvscosingle <- as.ggplot(ggcyto(selset.yeast.iccmmmv[i],
                                        aes(x=`SSC-H`,y=`FSC-H`),
                                        subset="Singlets") + geom_hex(bins=512) + 
                                   theme_bw() + 
                                   geom_gate(polyGateICCyeastSConly)+ 
                                   ggcyto_par_set(limits="instrument"))
  yeastscatterslides <- ph_with(yeastscatterslides, 
                              value = piccmmmvscosingle, 
                              location = ph_location_type(type = "body"))
  
}


print(yeastscatterslides,target="gatinginspection_singlets.pptx")


```


###### Secondary gating on scatter and fluorescence

The above serves as a primary noise filter, next we employ the *K. pastoris*
scatter-gated info to look into fluorescence based gating 

```{r fluorescence_gating, echo=TRUE, warning=FALSE,message=FALSE,cache=TRUE, fig.cap="Demonstration of secondary gating results on KP after filtering based upon the yeast cell scatter gate.",cache=TRUE, cache.lazy=FALSE}
recompute(selset.yeast.iccmmmv)


primaryscatteryeast <- gs_pop_get_gs(selset.yeast.iccmmmv,
      pop = "/Singlets/Yeast Cells scatter alone")

pICCMMVscBL1y <- selset.yeast.iccmmmv[sample(1:length(selset.yeast.iccmmmv),
                                             9)] %>% 
                      ggcyto(aes(x=`SSC-H`,y=`BL1-H`),
              subset="/Singlets/Yeast Cells scatter alone")
pICCMMVscBL1y + geom_hex(bins=256) + geom_gate(polyGateICCyeastSC) + 
          geom_gate(polyGateICCbactSC,colour="darkgreen") + 
          ggcyto_par_set(limits="instrument") + theme_bw()

node3 <- gs_pop_add(selset.yeast.iccmmmv,polyGateICCyeastSC,
                    parent="/Singlets/Yeast Cells scatter alone")

recompute(selset.yeast.iccmmmv)


# use officer for slides -------------------------------------------------------
yeastfluoscatterslides <- read_pptx()
yeastfluoscatterslides <- add_slide(yeastfluoscatterslides,layout = "Title Slide",
                                master = "Office Theme")
# layout_properties(yeastscatterslides,layout = "Title Slide")
yeastfluoscatterslides <- ph_with(yeastfluoscatterslides,
                              value="Gating manual verification slides - SSC/BL1",
                              location=ph_location_type(type="ctrTitle"))
yeastfluoscatterslides <- ph_with(yeastfluoscatterslides,
                              value="For check by Myrsini and Alexandra",
                              location=ph_location_type(type="subTitle"))
yeastfluoscatterslides <- ph_with(yeastfluoscatterslides, 
                              value = format(Sys.Date()), 
                              location = ph_location_type(type = "dt"))
yeastfluoscatterslides <- ph_with(yeastfluoscatterslides, value = "slide 1", 
                              location = ph_location_type(type = "sldNum"))

yeastfluoscatterslides <- add_slide(yeastfluoscatterslides,layout = "Section Header",
                                master = "Office Theme")

yeastfluoscatterslides <- ph_with(yeastfluoscatterslides,
                              value="Scatter & fluorescence -based secondary gating for yeast MMMV",
                              location=ph_location_type(type="title"))
yeastfluoscatterslides <- ph_with(yeastfluoscatterslides, 
                              value = format(Sys.Date()), 
                              location = ph_location_type(type = "dt"))
yeastfluoscatterslides <- ph_with(yeastfluoscatterslides, value = "slide 2", 
                              location = ph_location_type(type = "sldNum"))
### yeast scatter & BL1 secondary ----------------------------------------------
for(i in 1:length(selset.yeast.iccmmmv)){
  yeastfluoscatterslides <- add_slide(yeastfluoscatterslides,
                                  layout = "Title and Content",
                                  master = "Office Theme")
  yeastfluoscatterslides <- ph_with(yeastfluoscatterslides, 
                              value = format(Sys.Date()), 
                              location = ph_location_type(type = "dt"))
  yeastfluoscatterslides <- ph_with(yeastfluoscatterslides, 
                                value = paste0("slide ",i+2), 
                              location = ph_location_type(type = "sldNum"))
  piccmmmvflscsecsing <- as.ggplot(ggcyto(selset.yeast.iccmmmv[i],
                                        aes(x=`SSC-H`,y=`BL1-H`),
                                        subset="/Singlets/Yeast Cells scatter alone") + 
                                     geom_hex(bins=256) + geom_gate(polyGateICCyeastSC) + 
          geom_gate(polyGateICCbactSC,colour="darkgreen") + 
          theme_bw()+
                                   ggcyto_par_set(limits="instrument"))
  yeastfluoscatterslides <- ph_with(yeastfluoscatterslides, 
                              value = piccmmmvflscsecsing, 
                              location = ph_location_type(type = "body"))
  yeastfluoscatterslides <- add_slide(yeastfluoscatterslides,
                                  layout = "Title and Content",
                                  master = "Office Theme")
  yeastfluoscatterslides <- ph_with(yeastfluoscatterslides, 
                              value = format(Sys.Date()), 
                              location = ph_location_type(type = "dt"))
  yeastfluoscatterslides <- ph_with(yeastfluoscatterslides, 
                                value = paste0("slide ",i+2), 
                              location = ph_location_type(type = "sldNum"))
  piccmmmvflscsecsing <- as.ggplot(ggcyto(selset.yeast.iccmmmv[i],
                                        aes(x=`SSC-H`,y=`BL1-H`),
                                        subset="/Singlets/Bacterial Cells scatter alone|Yeast Cells scatter alone") + 
                                     geom_hex(bins=256) + geom_gate(polyGateICCyeastSC) + 
          geom_gate(polyGateICCbactSC,colour="darkgreen") + 
          theme_bw()+
                                   ggcyto_par_set(limits="instrument"))
  yeastfluoscatterslides <- ph_with(yeastfluoscatterslides, 
                              value = piccmmmvflscsecsing, 
                              location = ph_location_type(type = "body"))
  
}


print(yeastfluoscatterslides,target="gatinginspectionfluo_singlets.pptx")

```



###### Tertiairy gating ICC/DCC 

```{r iccdccgating_tertofficer,warning=FALSE,message=FALSE,cache=TRUE,cache.lazy=FALSE}
mixnodes <- gs_get_pop_paths(selset.mix.iccmmmv)
# use officer for slides -------------------------------------------------------
yeastfluoslides <- read_pptx()
yeastfluoslides <- add_slide(yeastfluoslides,layout = "Title Slide",
                                master = "Office Theme")
# layout_properties(yeastfluoslides,layout = "Title Slide")
yeastfluoslides <- ph_with(yeastfluoslides,
                              value="Gating manual verification slides - BL1/BL3",
                              location=ph_location_type(type="ctrTitle"))
yeastfluoslides <- ph_with(yeastfluoslides,
                              value="For check by Myrsini and Alexandra",
                              location=ph_location_type(type="subTitle"))
yeastfluoslides <- ph_with(yeastfluoslides, 
                              value = format(Sys.Date()), 
                              location = ph_location_type(type = "dt"))
yeastfluoslides <- ph_with(yeastfluoslides, value = "slide 1", 
                              location = ph_location_type(type = "sldNum"))

yeastfluoslides <- add_slide(yeastfluoslides,layout = "Section Header",
                                master = "Office Theme")

yeastfluoslides <- ph_with(yeastfluoslides,
                              value="Fluoresence based tertiary ICC/DCC gating for yeast MMMV",
                              location=ph_location_type(type="title"))
yeastfluoslides <- ph_with(yeastfluoslides, 
                              value = format(Sys.Date()), 
                              location = ph_location_type(type = "dt"))
yeastfluoslides <- ph_with(yeastfluoslides, value = "slide 2", 
                              location = ph_location_type(type = "sldNum"))
### yeast BL1/BL3 tertiary  ----------------------------------------------------
for(i in 1:length(selset.yeast.iccmmmv)){
  yeastfluoslides <- add_slide(yeastfluoslides,
                                  layout = "Title and Content",
                                  master = "Office Theme")
  yeastfluoslides <- ph_with(yeastfluoslides, 
                              value = format(Sys.Date()), 
                              location = ph_location_type(type = "dt"))
  yeastfluoslides <- ph_with(yeastfluoslides, 
                                value = paste0("slide ",i+2), 
                              location = ph_location_type(type = "sldNum"))
  piccmmmvfltertsing <- as.ggplot(ggcyto(selset.yeast.iccmmmv[i],
                                        aes(x=`BL1-H`,y=`BL3-H`),
          subset="/Singlets/Yeast Cells scatter alone/Yeast Cells scatter") + 
                                     geom_hex(bins=512) + 
            geom_gate(polyGateDCC) + 
          geom_gate(polyGateICCyeast,colour="darkgreen") + 
          theme_bw()+
                                   ggcyto_par_set(limits="instrument"))
  yeastfluoslides <- ph_with(yeastfluoslides, 
                              value = piccmmmvfltertsing, 
                              location = ph_location_type(type = "body"))
  
  
}

print(yeastfluoslides,target="gatinginspectionfluo_tertiairy.pptx")
```




```{r iccdccgating_tert_y, warning=FALSE,message=FALSE,fig.cap="ICC and DCC gates for 9 random yeast samples after primary and secondary gating."}
pICCMMVBL1BL3y <- selset.yeast.iccmmmv[sample(1:length(selset.yeast.iccmmmv),
                                             9)] %>% 
                      ggcyto(aes(x=`BL1-H`,y=`BL3-H`),
              subset="/Singlets/Yeast Cells scatter alone/Yeast Cells scatter")
pICCMMVBL1BL3y + geom_hex(bins=256) + geom_gate(polyGateDCC) + 
          geom_gate(polyGateICCyeast,colour="darkgreen") + 
          ggcyto_par_set(limits="instrument") + theme_bw()
```



##### Primary gating ICC/DCC 

In order to be more cautious about losing potentially relevant cell populations,
we also applied immediate gating on the singlets for ICC/DCC inference.

```{r iccdccgating_primyp, warning=FALSE,message=FALSE,fig.cap="ICC and DCC gates for 9 random yeast samples after singlet gating."}
pICCMMVBL1BL3yp <-
  selset.yeast.iccmmmv[sample(1:length(selset.yeast.iccmmmv),
                              9)] %>%
  ggcyto(aes(x = `BL1-H`, y = `BL3-H`),
         subset = "/Singlets")
pICCMMVBL1BL3yp + geom_hex(bins = 256) + geom_gate(polyGateDCCprim) +
  geom_gate(polyGateICCyeastprim, colour = "darkgreen") +
  ggcyto_par_set(limits = "instrument") + theme_bw()
```


##### Primary gating BL1/SSC, secondary ICC/DCC 


```{r fluorescencescprim_gating, echo=TRUE, warning=FALSE,message=FALSE,cache=TRUE, fig.cap="Demonstration of primary gating results on KP after filtering based upon the singlets.",cache=TRUE, cache.lazy=FALSE}
recompute(selset.yeast.iccmmmv)


node10a <- gs_pop_add(selset.yeast.iccmmmv,
                      polyGateICCyeastSCprim,
                      parent = "/Singlets")


pICCMMVBL1SSCy <-
  selset.yeast.iccmmmv[sample(1:length(selset.yeast.iccmmmv),
                              9)] %>%
  ggcyto(aes(x = `SSC-H`, y = `BL1-H`),
         subset = "/Singlets")
pICCMMVBL1SSCy + geom_hex(bins = 256) + geom_gate(polyGateICCyeastSCprim) +
  geom_gate(polyGateICCbactSCprim, colour = "darkgreen") +
  ggcyto_par_set(limits = "instrument") + theme_bw()



# use officer for slides -------------------------------------------------------
fluoscatterprimslides <- read_pptx()
fluoscatterprimslides <-
  add_slide(fluoscatterprimslides, layout = "Title Slide",
            master = "Office Theme")
# layout_properties(yeastscatterslides,layout = "Title Slide")
fluoscatterprimslides <- ph_with(fluoscatterprimslides,
                                 value = "Gating manual verification slides - SSC/BL1 as primary",
                                 location = ph_location_type(type = "ctrTitle"))
fluoscatterprimslides <- ph_with(fluoscatterprimslides,
                                 value = "For check by Myrsini and Alexandra",
                                 location = ph_location_type(type = "subTitle"))
fluoscatterprimslides <- ph_with(
  fluoscatterprimslides,
  value = format(Sys.Date()),
  location = ph_location_type(type = "dt")
)
fluoscatterprimslides <-
  ph_with(fluoscatterprimslides,
          value = "slide 1",
          location = ph_location_type(type = "sldNum"))

fluoscatterprimslides <-
  add_slide(fluoscatterprimslides, layout = "Section Header",
            master = "Office Theme")

fluoscatterprimslides <- ph_with(fluoscatterprimslides,
                                 value = "Scatter & fluorescence -based primary gating for yeast MMMV",
                                 location = ph_location_type(type = "title"))
fluoscatterprimslides <- ph_with(
  fluoscatterprimslides,
  value = format(Sys.Date()),
  location = ph_location_type(type = "dt")
)
fluoscatterprimslides <-
  ph_with(fluoscatterprimslides,
          value = "slide 2",
          location = ph_location_type(type = "sldNum"))
### yeast scatter & BL1 primary ----------------------------------------------
for (i in 1:length(selset.yeast.iccmmmv)) {
  fluoscatterprimslides <- add_slide(fluoscatterprimslides,
                                     layout = "Title and Content",
                                     master = "Office Theme")
  fluoscatterprimslides <- ph_with(
    fluoscatterprimslides,
    value = format(Sys.Date()),
    location = ph_location_type(type = "dt")
  )
  fluoscatterprimslides <- ph_with(
    fluoscatterprimslides,
    value = paste0("slide ", i + 2),
    location = ph_location_type(type = "sldNum")
  )
  piccmmmvflscprimsing <- as.ggplot(
    ggcyto(selset.yeast.iccmmmv[i],
           aes(x = `SSC-H`, y = `BL1-H`),
           subset = "/Singlets") +
      geom_hex(bins = 512) +
      geom_gate(polyGateICCyeastSCprim) +
      geom_gate(polyGateICCbactSCprim,
                colour = "darkgreen") +
      theme_bw() +
      ggcyto_par_set(limits = "instrument")
  )
  fluoscatterprimslides <- ph_with(fluoscatterprimslides,
                                   value = piccmmmvflscprimsing,
                                   location = ph_location_type(type = "body"))
}


print(fluoscatterprimslides,target="gatinginspectionBL1SSCprimary_singlets.pptx")

```



#### Results ICC/DCC

##### From tertiary gating

```{r ICCDCCtergat}
# iccmeta <- metadata_all %>% dplyr::filter(`Toanalyze?`=="Yes"&target=="ICC")
# selnamesICC <- c(sampleNames(selset.yeast.iccmmmv),sampleNames(selset.bact.iccmmmv),
#   sampleNames(selset.bact.iccams),sampleNames(selset.mix.iccmmmv))
# iccmeta.sel <- iccmeta[iccmeta$filenames%in%selnamesICC,]
# 
# openxlsx::write.xlsx(iccmeta.sel,file="ICCmetadata_for_dilutions.xlsx")
### filter correct dilutions ---------------------------------------------------
#### for yeast -----------------------------------------------------------------
correct_dilutions <- cordillstert %>% dplyr::filter(appropriate_dil_tert=="yes")
yeastcormd <- correct_dilutions %>% dplyr::filter(strain=="KP") %>% select(filenames,
                                                                           acquisitionvol,
                                                                           acquisitiondate,
                                                                           dilution,
                                                                           Replicateno)
yeastcormd$dilution_numeric <- 1L
yeastcormd$dilution_numeric[yeastcormd$dilution=="10min1"] <- 10L
yeastcormd$dilution_numeric[yeastcormd$dilution=="10min2"] <- 1e2L
yeastcormd$dilution_numeric[yeastcormd$dilution=="10min3"] <- 1e3L

yeastcormd$tpt <- gsub(".*_(t[0-9]).*","\\1",yeastcormd$filenames)

#### for ME in MMMV ------------------------------------------------------------
MEMMMVcormd <- correct_dilutions %>% 
                  dplyr::filter(strain=="ME"&Medium=="MMMV") %>% 
                  select(filenames,
                         acquisitionvol,
                         acquisitiondate,
                         dilution,
                         Replicateno)
MEMMMVcormd$dilution_numeric <- 1L
MEMMMVcormd$dilution_numeric[MEMMMVcormd$dilution=="10min1"] <- 10L
MEMMMVcormd$dilution_numeric[MEMMMVcormd$dilution=="10min2"] <- 1e2L
MEMMMVcormd$dilution_numeric[MEMMMVcormd$dilution=="10min3"] <- 1e3L

MEMMMVcormd$tpt <- gsub(".*_(t[0-9]).*","\\1",MEMMMVcormd$filenames)

#### for ME in AMS ------------------------------------------------------------
MEAMScormd <- correct_dilutions %>% 
                  dplyr::filter(strain=="ME"&Medium=="AMS") %>% 
                  select(filenames,
                         acquisitionvol,
                         acquisitiondate,
                         dilution,
                         Replicateno)
MEAMScormd$dilution_numeric <- 1L
MEAMScormd$dilution_numeric[MEAMScormd$dilution=="10min1"] <- 10L
MEAMScormd$dilution_numeric[MEAMScormd$dilution=="10min2"] <- 1e2L
MEAMScormd$dilution_numeric[MEAMScormd$dilution=="10min3"] <- 1e3L
MEAMScormd$dilution_numeric[MEAMScormd$dilution=="10min4"] <- 1e4L

MEAMScormd$tpt <- gsub(".*_(t[0-9]).*","\\1",MEAMScormd$filenames)

#### for Mix in MMMV -----------------------------------------------------------
MEMIXcormd <- correct_dilutions %>% 
                  dplyr::filter(strain=="KPME"&Medium=="MMMV") %>% 
                  select(filenames,
                         acquisitionvol,
                         acquisitiondate,
                         dilution,
                         Replicateno)
MEMIXcormd$dilution_numeric <- 1L
MEMIXcormd$dilution_numeric[MEMIXcormd$dilution=="10min1"] <- 10L
MEMIXcormd$dilution_numeric[MEMIXcormd$dilution=="10min2"] <- 1e2L
MEMIXcormd$dilution_numeric[MEMIXcormd$dilution=="10min3"] <- 1e3L
MEMIXcormd$dilution_numeric[MEMIXcormd$dilution=="10min4"] <- 1e4L
MEMIXcormd$tpt <- gsub(".*_(t[0-9]).*","\\1",MEMIXcormd$filenames)

### get nodes ------------------------------------------------------------------
yeastnodes <- gs_get_pop_paths(selset.yeast.iccmmmv)
bactMMMVnodes <- gs_get_pop_paths(selset.bact.iccmmmv)
bactAMSnodes <- gs_get_pop_paths(selset.bact.iccams)
mixnodes <- gs_get_pop_paths(selset.mix.iccmmmv)

### get stats ------------------------------------------------------------------

yeastpopstert <- gs_pop_get_count_fast(selset.yeast.iccmmmv[yeastcormd$filenames],
                                       subpopulations = c(yeastnodes[7],
                                                          yeastnodes[8]))

bacpopstert <- gs_pop_get_count_fast(selset.bact.iccmmmv[MEMMMVcormd$filenames],
                                       subpopulations = c(bactMMMVnodes[7],
                                                          bactMMMVnodes[8]))

bacapopstert <- gs_pop_get_count_fast(selset.bact.iccams[MEAMScormd$filenames],
                                       subpopulations = c(bactAMSnodes[7],
                                                          bactAMSnodes[8]))

mixpopstert <- gs_pop_get_count_fast(selset.mix.iccmmmv[MEMIXcormd$filenames],
                                       subpopulations = c(mixnodes[11],
                                                          mixnodes[12],
                                                          mixnodes[9],
                                                          mixnodes[10]))

yeastpopstert.md <- inner_join(yeastpopstert,yeastcormd,by=c("name"="filenames"))
yeastpopstert.md$strain <- "KP"
bacpopstert.md <- inner_join(bacpopstert,MEMMMVcormd,by=c("name"="filenames"))
bacpopstert.md$strain <- "ME_MMMV"
bacapopstert.md <- inner_join(bacapopstert,MEAMScormd,by=c("name"="filenames"))
bacapopstert.md$strain <- "ME_AMS"
mixpopstert.md <- inner_join(mixpopstert,MEMIXcormd,by=c("name"="filenames"))
mixpopstert.md$strain <- "ME_MMMV_mix"
mixpopstert.md$strain[grep("Yeast",mixpopstert.md$Population)]<-"KP_mix"

tertall <- rbind(yeastpopstert.md,bacpopstert.md,bacapopstert.md,mixpopstert.md)
tertall$membrane_integrity <- "Intact"
tertall$membrane_integrity[grep("Damaged",tertall$Population)]<-"Damaged"
tertall$tptnumeric <- as.numeric(gsub("t","",tertall$tpt))
tertall$tpth <- 0
tertall$tpth[tertall$tpt=="t1"]<-14.5
tertall$tpth[tertall$tpt=="t2"]<-19.5
tertall$tpth[tertall$tpt=="t3"]<-24
tertall$tpth[tertall$tpt=="t4"]<-38.5
tertall$tpth[tertall$tpt=="t5"]<-43.5
tertall$tpth[tertall$tpt=="t6"]<-48
tertall$tpth[tertall$tpt=="t7"]<-62.5
tertall$tpth[tertall$tpt=="t8"]<-67.5
tertall$tpth[tertall$tpt=="t9"]<-72


tertall$concentration <- tertall$Count/(as.numeric(tertall$acquisitionvol)/1e3L)*1e3L*tertall$dilution_numeric

wbtert <- openxlsx::createWorkbook()
openxlsx::addWorksheet(wbtert,sheetName = "Raw tertiary")
openxlsx::writeData(wbtert,sheet="Raw tertiary",tertall)

tertall.plot <- tertall %>% ggplot(aes(x=tpth,y=concentration,
                                       shape=membrane_integrity,fill=strain,
                                       color=strain))
tertall.plot + geom_point(size=3) + geom_smooth(se=TRUE) + scale_y_log10() + 
               facet_grid(membrane_integrity~strain,scales="free") + theme_bw() +
               ylab("Cell concentration (cells/mL)") + xlab("Time of cultivation (h)") +
               scale_shape_discrete(name="Membrane\nintegrity") +
               scale_color_discrete(name="Strain") +
               scale_fill_discrete(name="Strain")

tertall.sumd <- tertall %>% group_by(strain,membrane_integrity,tpt) %>%
                            summarise(avg_conc=mean(concentration),
                                      sd_conc=sd(concentration))
tertall.sumd$tptnumeric <- as.numeric(gsub("t","",tertall.sumd$tpt))

tertall.sumd$tpth <- 0
tertall.sumd$tpth[tertall.sumd$tpt=="t1"]<-14.5
tertall.sumd$tpth[tertall.sumd$tpt=="t2"]<-19.5
tertall.sumd$tpth[tertall.sumd$tpt=="t3"]<-24
tertall.sumd$tpth[tertall.sumd$tpt=="t4"]<-38.5
tertall.sumd$tpth[tertall.sumd$tpt=="t5"]<-43.5
tertall.sumd$tpth[tertall.sumd$tpt=="t6"]<-48
tertall.sumd$tpth[tertall.sumd$tpt=="t7"]<-62.5
tertall.sumd$tpth[tertall.sumd$tpt=="t8"]<-67.5
tertall.sumd$tpth[tertall.sumd$tpt=="t9"]<-72

openxlsx::addWorksheet(wbtert,sheetName = "Summarised tertiary")
openxlsx::writeData(wbtert,sheet="Summarised tertiary",tertall.sumd)
openxlsx::saveWorkbook(wbtert,file = "Tertiary_gating_concentrations.xlsx")

tertallsumd.plot <- tertall.sumd %>% ggplot(aes(x=tpth,y=avg_conc,
                                       shape=membrane_integrity,fill=strain,
                                       color=strain))



tertallsumd.plot + geom_point(size=3) + geom_errorbar(aes(ymin=avg_conc,
                                                          ymax=avg_conc+sd_conc)) +
               geom_line() + scale_y_log10() +
               facet_grid(membrane_integrity~strain,scales="free") + theme_bw() +
               ylab("Cell concentration (cells/mL)") + xlab("Time of cultivation (h)") +
               scale_shape_discrete(name="Membrane\nintegrity") +
               scale_color_discrete(name="Strain") +
               scale_fill_discrete(name="Strain")

```


#### Cell size and biovolume over time {.tabset .tabset-pills}

##### Apply to ICC data

```{r resicc}
## For the ICC flowSet ---------------------------------------------------------
fcs_x   <- tertyeastfs.sing.icc
# filter out params of interest
fcs_x <- fcs_x[, param]
# actual size inferences
results_sizing.icc <- fsApply(fcs_x, use.exprs = TRUE, function(x) {
  x <-
    x[, param[1:2], drop = FALSE]
  colnames(x) <- c("param_1", "param_2")
  RF_pred <-
    data.table(predict.train(KYTOmodel_micropart, newdata = x))
})
results_sizing_BV.icc <- fsApply(fcs_x, use.exprs = TRUE, function(x) {
  x <-
    x[, param[1:2], drop = FALSE]
  colnames(x) <-   c("param_1", "param_2")
  RF_pred <-
    data.table(predict.train(KYTOmodel_micropart_BV, newdata = x))
})
# we calculated the results in a summary format 
results_sizing.icc.summary <- data.table(
  Sample_names = names(results_sizing.icc),
  med_value = unlist(lapply(
    results_sizing.icc,
    FUN = function(x)
      median(x$V1)
  )),
  q25 = unlist(lapply(
    results_sizing.icc,
    FUN = function(x)
      quantile(x$V1, probs = 0.25)
  )),
  q75 = unlist(lapply(
    results_sizing.icc,
    FUN = function(x)
      quantile(x$V1, probs = 0.75)
  )),
  ncells = unlist(lapply(
    results_sizing.icc,
    FUN = function(x)
      length(x$V1)
  ))
)
results_sizing_BV.icc.summary <- data.table(
  Sample_names = names(results_sizing_BV.icc),
  med_value = unlist(lapply(
    results_sizing_BV.icc,
    FUN = function(x)
      median(x$V1)
  )),
  q25 = unlist(lapply(
    results_sizing_BV.icc,
    FUN = function(x)
      quantile(x$V1, probs = 0.25)
  )),
  q75 = unlist(lapply(
    results_sizing_BV.icc,
    FUN = function(x)
      quantile(x$V1, probs = 0.75)
  )),
  ncells = unlist(lapply(
    results_sizing_BV.icc,
    FUN = function(x)
      length(x$V1)
  ))
)
openxlsx::addWorksheet(reswb,sheetName = "ICC_diameter")
openxlsx::writeData(reswb,sheet="ICC_diameter",x = results_sizing.icc.summary)
openxlsx::addWorksheet(reswb,sheetName = "ICC_volume")
openxlsx::writeData(reswb,sheet="ICC_volume",x = results_sizing_BV.icc.summary)
sizeicc.md <- dplyr::left_join(results_sizing.icc.summary,
                               iccmeta.sel,
                               by=c("Sample_names"="filenames"))
sizeicc.md$timepoint <- gsub(".*(t[0-9]).*","\\1",sizeicc.md$Sample_names)
sizeicc.md %>% dplyr::filter(ncells>500) %>% group_by(timepoint,dilution) %>% 
               summarise(avgmedsize=mean(med_value),
                         sdmedsize=sd(med_value)) %>%
               ggplot(.,aes(x=timepoint,y=avgmedsize,color=dilution)) +
               geom_point() + geom_smooth(se=FALSE) + 
               geom_errorbar(aes(ymin=avgmedsize-sdmedsize,
                                 ymax=avgmedsize+sdmedsize)) +
               theme_bw() + xlab("Incubation timepoint") + 
               ylab("Average of the median cell size across biological replicates (µm, n=4)")
openxlsx::saveWorkbook(reswb,file = "results/FcM_results.xlsx",overwrite = TRUE)
```

##### Apply to SYPRO data

```{r ressypro}
## For the SYPRO flowSet ---------------------------------------------------------
fcs_x   <- hierarchfsSYPRO.clean.atd
# filter out params of interest
fcs_x <- fcs_x[, param]
# actual size inferences
results_sizing.sypro <- fsApply(fcs_x, use.exprs = TRUE, function(x) {
  x <-
    x[, param[1:2], drop = FALSE]
  colnames(x) <- c("param_1", "param_2")
  RF_pred <-
    data.table(predict.train(KYTOmodel_micropart, newdata = x))
})
results_sizing_BV.sypro <- fsApply(fcs_x, use.exprs = TRUE, function(x) {
  x <-
    x[, param[1:2], drop = FALSE]
  colnames(x) <-   c("param_1", "param_2")
  RF_pred <-
    data.table(predict.train(KYTOmodel_micropart_BV, newdata = x))
})
# we calculated the results in a summary format 
results_sizing.sypro.summary <- data.table(
  Sample_names = names(results_sizing.sypro),
  med_value = unlist(lapply(
    results_sizing.sypro,
    FUN = function(x)
      median(x$V1)
  )),
  q25 = unlist(lapply(
    results_sizing.sypro,
    FUN = function(x)
      quantile(x$V1, probs = 0.25)
  )),
  q75 = unlist(lapply(
    results_sizing.sypro,
    FUN = function(x)
      quantile(x$V1, probs = 0.75)
  )),
  ncells = unlist(lapply(
    results_sizing.sypro,
    FUN = function(x)
      length(x$V1)
  ))
)
results_sizing_BV.sypro.summary <- data.table(
  Sample_names = names(results_sizing_BV.sypro),
  med_value = unlist(lapply(
    results_sizing_BV.sypro,
    FUN = function(x)
      median(x$V1)
  )),
  q25 = unlist(lapply(
    results_sizing_BV.sypro,
    FUN = function(x)
      quantile(x$V1, probs = 0.25)
  )),
  q75 = unlist(lapply(
    results_sizing_BV.sypro,
    FUN = function(x)
      quantile(x$V1, probs = 0.75)
  )),
  ncells = unlist(lapply(
    results_sizing_BV.sypro,
    FUN = function(x)
      length(x$V1)
  ))
)
openxlsx::addWorksheet(reswb,sheetName = "SYPRO_diameter")
openxlsx::writeData(reswb,sheet="SYPRO_diameter",x = results_sizing.sypro.summary)
openxlsx::addWorksheet(reswb,sheetName = "SYPRO_volume")
openxlsx::writeData(reswb,sheet="SYPRO_volume",x = results_sizing_BV.sypro.summary)

openxlsx::saveWorkbook(reswb,file = "results/FcM_results.xlsx",overwrite = TRUE)
```

##### Apply to BODIPY data

```{r resbodipy}
## For the BODIPY flowSet ---------------------------------------------------------
fcs_x   <- hierarchfsBODIPYKP.clean.atd
# filter out params of interest
fcs_x <- fcs_x[, param]
# actual size inferences
results_sizing.bodipy <-
  fsApply(fcs_x, use.exprs = TRUE, function(x) {
    x <-
      x[, param[1:2], drop = FALSE]
    colnames(x) <- c("param_1", "param_2")
    RF_pred <-
      data.table(predict.train(KYTOmodel_micropart, newdata = x))
  })
results_sizing_BV.bodipy <-
  fsApply(fcs_x, use.exprs = TRUE, function(x) {
    x <-
      x[, param[1:2], drop = FALSE]
    colnames(x) <-   c("param_1", "param_2")
    RF_pred <-
      data.table(predict.train(KYTOmodel_micropart_BV, newdata = x))
  })
# we calculated the results in a summary format
results_sizing.bodipy.summary <- data.table(
  Sample_names = names(results_sizing.bodipy),
  med_value = unlist(lapply(
    results_sizing.bodipy,
    FUN = function(x)
      median(x$V1)
  )),
  q25 = unlist(lapply(
    results_sizing.bodipy,
    FUN = function(x)
      quantile(x$V1, probs = 0.25)
  )),
  q75 = unlist(lapply(
    results_sizing.bodipy,
    FUN = function(x)
      quantile(x$V1, probs = 0.75)
  )),
  ncells = unlist(lapply(
    results_sizing.bodipy,
    FUN = function(x)
      length(x$V1)
  ))
)
results_sizing_BV.bodipy.summary <- data.table(
  Sample_names = names(results_sizing_BV.bodipy),
  med_value = unlist(lapply(
    results_sizing_BV.bodipy,
    FUN = function(x)
      median(x$V1)
  )),
  q25 = unlist(lapply(
    results_sizing_BV.bodipy,
    FUN = function(x)
      quantile(x$V1, probs = 0.25)
  )),
  q75 = unlist(lapply(
    results_sizing_BV.bodipy,
    FUN = function(x)
      quantile(x$V1, probs = 0.75)
  )),
  ncells = unlist(lapply(
    results_sizing_BV.bodipy,
    FUN = function(x)
      length(x$V1)
  ))
)
openxlsx::addWorksheet(reswb, sheetName = "BODIPY_diameter")
openxlsx::writeData(reswb, sheet = "BODIPY_diameter", 
                    x = results_sizing.bodipy.summary)
openxlsx::addWorksheet(reswb, sheetName = "BODIPY_volume")
openxlsx::writeData(reswb, sheet = "BODIPY_volume", 
                    x = results_sizing_BV.bodipy.summary)

openxlsx::saveWorkbook(reswb, file = "Results/FcM_results.xlsx", 
                       overwrite = TRUE)
```


#### Protein and nucleic acid 

##### Gating strategy

```{r syprogatesandpreprocessing, echo=FALSE,warning=FALSE,message=FALSE,cache.lazy=FALSE}
# SYPRO dataset ----------------------------------------------------------------
## ETL -------------------------------------------------------------------------
mddf.toanalyze.SYPRO.MMMV.KP <- mddf.toanalyze %>%
  dplyr::filter(target == "PROTEIN" &
                  Medium == "MMMV" &
                  strain == "KP")

mddf.toanalyze.SYPRO.MMMV.KP$timepoint <-
  gsub(".*(t[0-9]).fcs",
       "\\1",
       mddf.toanalyze.SYPRO.MMMV.KP$filenames)

flowsetSYPROKP <- allfs.orig[mddf.toanalyze.SYPRO.MMMV.KP$filenames]

flowsetSYPROKP.clean <- FCS_clean(flowsetSYPROKP,
                                  param = c("BL2-H", "RL1-H",
                                            "SSC-H", "FSC-H"))

chnls <- colnames(flowsetSYPROKP)[2:28]
transList <- transformerList(chnls, trans.obj)
gatingsetSYPROKP <- GatingSet(flowsetSYPROKP)
gatingsetSYPROKP <- transform(gatingsetSYPROKP, transList)
flowsetSYPROKP_transformed <-
  cytoset_to_flowSet(gs_pop_get_data(gatingsetSYPROKP))

gatingsetSYPROKP.hier <- GatingSet(flowsetSYPROKP)
gatingsetSYPROKP.hier <- transform(gatingsetSYPROKP.hier, transList)


gatingsetSYPROKP.hier.clean <- GatingSet(flowsetSYPROKP.clean)
gatingsetSYPROKP.hier.clean <-
  transform(gatingsetSYPROKP.hier.clean, transList)

## Gating strategy -------------------------------------------------------------
sqrcutSYPROSYTO <- matrix(c(5, 12, 15.0, 5,
                            5, 5, 14.5, 14.5),
                          ncol = 2,
                          nrow = 4)
colnames(sqrcutSYPROSYTO) <- c("BL2-H", "RL1-H")
polyGateSYPROSYTO <-
  polygonGate(.gate = sqrcutSYPROSYTO, filterId = "Dual positive")

sqrcutSYPROSSC <- matrix(
  c(4.6, 4.5, 4.50, 15.0, 15.0,
    6.1, 6.75, 12.5, 12.5, 6.1),
  ncol = 2,
  nrow = 5
)
colnames(sqrcutSYPROSSC) <- c("BL2-H", "SSC-H")
polyGateSYPROSSC <-
  polygonGate(.gate = sqrcutSYPROSSC, filterId = "SYPRO+")

nodes1 <- gs_pop_add(gatingsetSYPROKP.hier, polyGateSYPROSSC)
nodes2 <-
  gs_pop_add(gatingsetSYPROKP.hier, polyGateSYPROSYTO, parent = "SYPRO+")
recompute(gatingsetSYPROKP.hier)
plot(gatingsetSYPROKP.hier)

nodes1.clean <-
  gs_pop_add(gatingsetSYPROKP.hier.clean, polyGateSYPROSSC)
nodes2.clean <- gs_pop_add(gatingsetSYPROKP.hier.clean,
                           polyGateSYPROSYTO, parent = "SYPRO+")
recompute(gatingsetSYPROKP.hier.clean)

pSYPROKPSYTOgates <- ggcyto(gatingsetSYPROKP.hier,
                            aes(x = "RL1-H", y = "BL2-H"), subset = "SYPRO+")
pSYPROKPSYTOgates + geom_hex(bins = 512) + theme_bw() + labs_cyto("marker") + ggcyto_par_set(limits =
                                                                                               "instrument") +
  geom_gate(polyGateSYPROSYTO, colour = "orangered") 
# pdf("Gating_hierarchy_SYPRO.pdf")
# lapply(gatingsetSYPRO.hier,function(x)autoplot(x,bins=256)+theme_bw())
# dev.off()

# for(i in sampleNames(gatingsetSYPROKP.hier)){
#   tiff(filename=paste0("Results/figures/",i,".tiff"),width=7,height = 7,
#        units = "in",res=900,
#        compression="lzw")
#   p <- autoplot(gatingsetSYPROKP.hier[[i]],bins=512)+theme_bw()
#   print(p)
#   dev.off()
# }
pSYPROSSCgates <- ggcyto(flowsetSYPROKP_transformed,
                    aes(y="SSC-H",x="BL2-H"))
pSYPROSSCgates + geom_hex(bins=256) + theme_bw() + labs_cyto("marker")+ ggcyto_par_set(limits="instrument")+
            geom_gate(polyGateSYPROSSC,colour="darkgreen") 


pSYPROSSCgatesclean <- ggcyto(gatingsetSYPROKP.hier,
                    aes(y="SSC-H",x="BL2-H"),subset="root")
pSYPROSSCgatesclean + geom_hex(bins=256) + theme_bw() + labs_cyto("marker")+ ggcyto_par_set(limits="instrument")+
            geom_gate(polyGateSYPROSSC,colour="darkgreen") 

pSYTOSSCgates <- ggcyto(flowsetSYPROKP_transformed,
                    aes(y="SSC-H",x="RL1-H"))
pSYTOSSCgates + geom_hex(bins=256) + theme_bw() + labs_cyto("marker")+ ggcyto_par_set(limits="instrument")


pSYPROFSCgates <- ggcyto(gatingsetSYPROKP.hier,
                    aes(y="FSC-H",x="BL2-H"),subset="root")
pSYPROFSCgates + geom_hex(bins=256) + theme_bw() + labs_cyto("marker")+ ggcyto_par_set(limits="instrument")

nodelistcl <- gs_get_pop_paths(gatingsetSYPROKP.hier.clean)

hierarchgsSYPROKP.clean <- gs_pop_get_data(gatingsetSYPROKP.hier.clean,
                                           nodelistcl[3])
hierarchfsSYPROKP.clean <- cytoset_to_flowSet(hierarchgsSYPROKP.clean)

## count, aggregate and annotate events for SYPRO after cleaning ----------------
countssypro <- fsApply(flowsetSYPROKP_transformed, nrow)
countssypro.clean <- fsApply(hierarchfsSYPROKP.clean, nrow)

cleanup.sypro.df <- data.frame(
  filenames = rownames(countssypro),
  raw_events = countssypro,
  cleaned_events = countssypro.clean
)

cleanup.sypro.df.md <-
  dplyr::left_join(cleanup.sypro.df, mddf.toanalyze.SYPRO.MMMV.KP) %>%
  pivot_longer(raw_events:cleaned_events,
               names_to = "cleaning_status",
               values_to = "events")

cleanup.sypro.df.md$cleaning_status <-
  factor(cleanup.sypro.df.md$cleaning_status,
         levels = c("raw_events",
                    "cleaned_events"))

psyproclean <- cleanup.sypro.df.md %>% ggplot(aes(x = timepoint,
                                                  y = events,
                                                  fill = cleaning_status))
psyproclean + geom_boxplot() + theme_bw()

# BODIPY dataset ----------------------------------------------------------------
## ETL -------------------------------------------------------------------------
mddf.toanalyze.BODIPY.MMMV.KP <- mddf.toanalyze %>%
  dplyr::filter(target == "PHA" &
                  Medium == "MMMV" &
                  strain == "KP")
# only analyse data acquired with the new settings
mddf.toanalyze.BODIPY.MMMV.KP <-
  mddf.toanalyze.BODIPY.MMMV.KP[grep("newsettings", mddf.toanalyze.BODIPY.MMMV.KP$filenames), ]

mddf.toanalyze.BODIPY.MMMV.KP$timepoint <-
  gsub(".*(t[0-9]).*.fcs",
       "\\1",
       mddf.toanalyze.BODIPY.MMMV.KP$filenames)

flowsetBODIPYKP <-
  allfs.orig[mddf.toanalyze.BODIPY.MMMV.KP$filenames]

flowsetBODIPYKP.clean <- FCS_clean(flowsetBODIPYKP,
                                   param = c("BL1-H", "RL1-H",
                                             "SSC-H", "FSC-H"))

chnls <- colnames(flowsetBODIPYKP)[2:28]
transList <- transformerList(chnls, trans.obj)
gatingsetBODIPYKP <- GatingSet(flowsetBODIPYKP)
gatingsetBODIPYKP <- transform(gatingsetBODIPYKP, transList)
flowsetBODIPYKP_transformed <-
  cytoset_to_flowSet(gs_pop_get_data(gatingsetBODIPYKP))

gatingsetBODIPYKP.hier <- GatingSet(flowsetBODIPYKP)
gatingsetBODIPYKP.hier <-
  transform(gatingsetBODIPYKP.hier, transList)


gatingsetBODIPYKP.hier.clean <- GatingSet(flowsetBODIPYKP.clean)
gatingsetBODIPYKP.hier.clean <-
  transform(gatingsetBODIPYKP.hier.clean, transList)

## design gates ----------------------------------------------------------------
sqrcutBODIPYSYTO <- matrix(
  c(5.00, 5.00, 9.00, 15.0, 11.0,
    8.2, 12.5, 14.5, 14.5, 7.40),
  ncol = 2,
  nrow = 5
)
colnames(sqrcutBODIPYSYTO) <- c("BL1-H", "RL1-H")
polyGateBODIPYSYTO <-
  polygonGate(.gate = sqrcutBODIPYSYTO, filterId = "Dual positive")

sqrcutSYTOSSC <- matrix(
  c(7.50, 7.50, 10.0, 15.0, 10,
    7.50, 12.5, 14.5, 14.5, 7.5),
  ncol = 2,
  nrow = 5
)
colnames(sqrcutSYTOSSC) <- c("SSC-H", "RL1-H")
polyGateSYTOSSC <-
  polygonGate(.gate = sqrcutSYTOSSC, filterId = "SYTO62+")

sqrcutBODIPYSSC <- matrix(c(5.00, 12.5, 15.0, 5.00,
                            7.50, 7.50, 13.5, 13.5),
                          ncol = 2,
                          nrow = 4)
colnames(sqrcutBODIPYSSC) <- c("BL1-H", "SSC-H")
polyGateBODIPYSSC <-
  polygonGate(.gate = sqrcutBODIPYSSC, filterId = "BODIPY493+")

pSYTOSSCgates <- ggcyto(flowsetBODIPYKP_transformed,
                        aes(x = "SSC-H", y = "RL1-H"))
pSYTOSSCgates + geom_hex(bins = 256) + theme_bw() + labs_cyto("marker") + ggcyto_par_set(limits =
                                                                                           "instrument") +
  geom_gate(polyGateSYTOSSC, colour = "darkred")

pBODIPYSSCgates <- ggcyto(flowsetBODIPYKP_transformed,
                          aes(x = "SSC-H", y = "BL1-H"))
pBODIPYSSCgates + geom_hex(bins = 256) + theme_bw() + labs_cyto("marker") + ggcyto_par_set(limits =
                                                                                             "instrument") +
  geom_gate(polyGateBODIPYSSC, colour = "darkgreen")

pBODIPYSYTOgates <- ggcyto(flowsetBODIPYKP_transformed,
                           aes(x = "RL1-H", y = "BL1-H"))
pBODIPYSYTOgates + geom_hex(bins = 256) + theme_bw() + labs_cyto("marker") + ggcyto_par_set(limits =
                                                                                              "instrument") +
  geom_gate(polyGateBODIPYSYTO, colour = "orangered")

nodes3 <- gs_pop_add(gatingsetBODIPYKP.hier, polyGateSYTOSSC)
nodes4 <-
  gs_pop_add(gatingsetBODIPYKP.hier, polyGateBODIPYSSC, parent = "SYTO62+")
nodes5 <-
  gs_pop_add(gatingsetBODIPYKP.hier, polyGateBODIPYSYTO, parent = "BODIPY493+")
recompute(gatingsetBODIPYKP.hier)
plot(gatingsetBODIPYKP.hier)

nodes3.clean <- gs_pop_add(gatingsetBODIPYKP.hier.clean,
                           polyGateSYTOSSC)
nodes4.clean <- gs_pop_add(gatingsetBODIPYKP.hier.clean,
                           polyGateBODIPYSSC,
                           parent = "SYTO62+")
nodes5.clean <- gs_pop_add(gatingsetBODIPYKP.hier.clean,
                           polyGateBODIPYSYTO,
                           parent = "BODIPY493+")
recompute(gatingsetBODIPYKP.hier.clean)
plot(gatingsetBODIPYKP.hier.clean)

# for(i in sampleNames(gatingsetBODIPYKP.hier)){
#   tiff(filename=paste0("Results/figures/",i,".tiff"),width=7,height = 7,
#        units = "in",res=900,
#        compression="lzw")
#   p <- autoplot(gatingsetBODIPYKP.hier[[i]],bins=256)+theme_bw()
#   print(p)
#   dev.off()
# }


nodelistclbp <- gs_get_pop_paths(gatingsetBODIPYKP.hier.clean)

hierarchgsBODIPYKP.clean <- gs_pop_get_data(gatingsetBODIPYKP.hier.clean,
                                           nodelistclbp[4])
hierarchfsBODIPYKP.clean <- cytoset_to_flowSet(hierarchgsBODIPYKP.clean)

## count, aggregate and annotate events for BODIPY after cleaning --------------
countsbodipy <- fsApply(flowsetBODIPYKP_transformed,nrow)
countsbodipy.clean <- fsApply(hierarchfsBODIPYKP.clean,nrow)

cleanup.bodipy.df <- data.frame(filenames=rownames(countsbodipy),
                               raw_events=countsbodipy,
                               cleaned_events=countsbodipy.clean)

cleanup.bodipy.df.md <- dplyr::left_join(cleanup.bodipy.df,
                                         mddf.toanalyze.BODIPY.MMMV.KP) %>%
                       pivot_longer(raw_events:cleaned_events,
                                    names_to="cleaning_status",
                                    values_to = "events")

cleanup.bodipy.df.md$cleaning_status <- factor(cleanup.bodipy.df.md$cleaning_status,
                                              levels=c("raw_events",
                                                      "cleaned_events"))

pbodipyclean <- cleanup.bodipy.df.md %>% ggplot(aes(x=timepoint,
                                                  y=events,
                                                  fill=cleaning_status))
pbodipyclean + geom_boxplot() + theme_bw()
```

### Mean fluorescence intentity

##### SYPRO data cleaned

```{r sypromfires}
pd.clean <- phenoData(hierarchfsSYPROKP.clean)
mddf.sypro.clean <- mddf.toanalyze.SYPRO.MMMV.KP[mddf.toanalyze.SYPRO.MMMV.KP$filenames  %in% sampleNames(hierarchfsSYPROKP.clean),]
pd.clean$timepoint <- mddf.sypro.clean$timepoint
pd.clean$experiment <- mddf.sypro.clean$experiment
hierarchfsSYPRO.clean.atd <- hierarchfsSYPROKP.clean
phenoData(hierarchfsSYPRO.clean.atd) <- pd.clean

psypro.clean <- ggcyto(hierarchfsSYPRO.clean.atd,aes(x=`BL2-H`))
# psypro + geom_density(aes(y = ..count..,fill=Timepoint)) + facet_grid(Treatment~Timepoint)
psypro.clean + geom_density(aes(fill = timepoint), bw = "SJ") +
  facet_wrap(timepoint ~ experiment) +
  theme_bw() + coord_flip() +
  theme(axis.text.x = element_text(angle = 270)) + ylab("Density") +
  geom_vline(xintercept = 6.5,
             lty = 2,
             alpha = 0.6)

bpsypro.clean <- ggcyto(hierarchfsSYPRO.clean.atd, aes(y = `BL2-H`,
                                                       fill = timepoint))
bpsypro.clean + geom_violin(aes(x = 1), bw = "SJ") +
  facet_grid( ~ timepoint) +
  geom_hline(yintercept = 6.5,
             lty = 2,
             alpha = 0.6) +
  theme_bw() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )

bpsypro.clean + geom_boxplot() + facet_grid(experiment ~ timepoint) +
  theme_bw() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )

medfluointenssypro_alone.clean <- gs_pop_get_stats(gatingsetSYPROKP.hier.clean,
                                             "/SYPRO+/Dual positive",
                                             type=pop.MFI)
reswb <- openxlsx::createWorkbook()
openxlsx::addWorksheet(reswb,sheetName = "MedianSypro_clean")
openxlsx::writeData(reswb,sheet="MedianSypro_clean",
                    x = medfluointenssypro_alone.clean)

meanfluointensSYPRO.clean <- fsApply(hierarchfsSYPRO.clean.atd,
                                     function(x)
                                       mean(x@exprs[, "BL2-H"]))
meanfluointensSYPRO.df.clean <-
  data.frame(filename = rownames(meanfluointensSYPRO.clean),
             mean_fluo_SYPRO = meanfluointensSYPRO.clean)

openxlsx::addWorksheet(reswb,sheetName = "MeanSypro_clean")
openxlsx::writeData(reswb,sheet="MeanSypro_clean",
                    x = meanfluointensSYPRO.df.clean)

```

#### SYTO62 MFI data clean

```{r sy62mfisyproclean, echo=FALSE,warning=FALSE,message=FALSE}

psyto.clean <- ggcyto(hierarchfsSYPRO.clean.atd, aes(x = `RL1-H`))
# psypro + geom_density(aes(y = ..count..,fill=Timepoint)) + facet_grid(Treatment~Timepoint)
psyto.clean + geom_density(aes(fill = timepoint), bw = "SJ") +
  facet_grid(experiment ~
               timepoint) +
  theme_bw() + coord_flip() +
  theme(axis.text.x = element_text(angle = 270)) +
  ylab("Density") +
  geom_vline(xintercept = 7,
             lty = 2,
             alpha = 0.6) + 
  labs_cyto("marker")
bpsyto.clean <- ggcyto(hierarchfsSYPRO.clean.atd,
                       aes(y = `RL1-H`, fill = timepoint))
bpsyto.clean + geom_violin(aes(x = 1), bw = "SJ") +
  facet_grid( ~ timepoint) +
  geom_hline(yintercept = 9,
             lty = 2,
             alpha = 0.6) +
  theme_bw() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )
bpsyto.clean + geom_boxplot() +
  facet_grid(experiment ~ timepoint) +
  geom_hline(yintercept = 7,
             lty = 2,
             alpha = 0.6) +
  theme_bw() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )

medfluointenssypro.clean <- gs_pop_get_stats(gatingsetSYPROKP.hier.clean,
                                             "/SYPRO+",type=pop.MFI)
openxlsx::addWorksheet(reswb,sheetName = "MedianSyto62_Sypro_clean")
openxlsx::writeData(reswb,sheet="MedianSyto62_Sypro_clean",
                    x = medfluointenssypro.clean)

meanfluointenssyto62.clean <- fsApply(hierarchfsSYPRO.clean.atd,
                                function(x)mean(x@exprs[,"RL1-H"]))
meanfluointenssyto62.df.clean <-
  data.frame(filename=rownames(meanfluointenssyto62.clean),
             mean_fluo_syto62=meanfluointenssyto62.clean)
openxlsx::addWorksheet(reswb,sheetName = "MeanSyto62_Sypro_clean")
openxlsx::writeData(reswb,sheet="MeanSyto62_Sypro_clean",
                    x = meanfluointenssyto62.df.clean)
#openxlsx::saveWorkbook(reswb,file = "results/FcM_results.xlsx",overwrite = TRUE)
```

## PHA

##### BODIPY data

```{r BODIPYresultsclean,echo=FALSE,warning=FALSE,message=FALSE, fig.cap=c("Gaussian kernel density estimates of asinh transformed BL1-H (BODIPY) emission intensity (A.U.) of all gated cells (including all replicates) after acquisition-level cleanup using a bandwidth estimation by Sheather & Jones (1991) using pilot estimation of derivatives.Colored by timepoint, facetted by inital amount of N supplied. Dashed line included for reference purposes only. Axes are constant among facets to enhance comparability.","Gaussian kernel density violin plots of asinh transformed BL1-H (BODIPY) emission intensity (A.U.) of all gated cells (including all replicates) after acquisition-level cleanup using a bandwidth estimation by Sheather & Jones (1991) using pilot estimation of derivatives. Colored by timepoint, facetted by inital amount of N supplied. Dashed line included for reference purposes only. Axes are constant among facets to enhance comparability.","Box-and-whisker plots of asinh transformed BL2-H (BODIPY) emission intensity (A.U.) of all gated cells (including all replicates) after acquisition-level cleanup. Colored by timepoint, facetted by inital amount of N supplied. Axes are constant among facets to enhance comparability.")}
# add phenodata for flowViz::densityplot ---------------------------------------
pdclean <- phenoData(hierarchfsBODIPYKP.clean)

pdclean$timepoint <- mddf.toanalyze.BODIPY.MMMV.KP$timepoint
pdclean$experiment    <- mddf.toanalyze.BODIPY.MMMV.KP$experiment

hierarchfsBODIPY.clean.atd <- hierarchfsBODIPYKP.clean
phenoData(hierarchfsBODIPY.clean.atd) <- pdclean

pbodipyclean <- ggcyto(hierarchfsBODIPY.clean.atd,aes(x=`BL1-H`))
# psypro + geom_density(aes(y = ..count..,fill=Timepoint)) + facet_grid(Treatment~Timepoint)
pbodipyclean + geom_density(aes(fill = timepoint), bw = "SJ") +
  facet_grid(experiment ~ timepoint) +
  theme_bw() +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 270)) +
  ylab("Density") +
  geom_vline(xintercept = 9,
             lty = 2,
             alpha = 0.6)
# pbodipy + geom_histogram(aes(fill=Timepoint),bins=100) + facet_grid(Treatment~Timepoint) + theme_bw()

bpbodipyclean <- ggcyto(hierarchfsBODIPY.clean.atd,
                        aes(y = `BL1-H`, fill = timepoint))
bpbodipyclean + geom_violin(aes(x = 1), bw = "SJ") +
  facet_grid( ~ timepoint) +
  geom_hline(yintercept = 9,
             lty = 2,
             alpha = 0.6) +
  theme_bw() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )

bpbodipyclean + geom_boxplot() +
  facet_grid(experiment ~ timepoint) +
  theme_bw() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )



medfluointensbodipy_alone.clean <-
  gs_pop_get_stats(gatingsetBODIPYKP.hier.clean,
                   "/SYTO62+/BODIPY493+/Dual positive",
                   type = pop.MFI)
openxlsx::addWorksheet(reswb, sheetName = "MedianBodipy_clean")
openxlsx::writeData(reswb, sheet = "MedianBodipy_clean",
                    x = medfluointensbodipy_alone.clean)

meanfluointensBODIPY.clean <- fsApply(hierarchfsBODIPY.clean.atd,
                                      function(x)
                                        mean(x@exprs[, "BL1-H"]))
meanfluointensBODIPY.clean.df <-
  data.frame(filename = rownames(meanfluointensBODIPY.clean),
             mean_fluo_SYPRO = meanfluointensBODIPY.clean)
openxlsx::addWorksheet(reswb, sheetName = "MeanBodipy_clean")
openxlsx::writeData(reswb, sheet = "MeanBodipy_clean",
                    x = meanfluointensBODIPY.clean.df)
```

##### SYTO62 MFI data

```{r sy62mfibodipyclean, echo=FALSE,warning=FALSE,message=FALSE,cache.lazy=FALSE}
pd62.clean <- phenoData(hierarchfsBODIPYKP.clean)
pd62.clean$experiment <- mddf.toanalyze.BODIPY.MMMV.KP$experiment
pd62.clean$timepoint <- mddf.toanalyze.BODIPY.MMMV.KP$timepoint


hierarchfsBODIPYKP.clean.atd <- hierarchfsBODIPYKP.clean
phenoData(hierarchfsBODIPYKP.clean.atd) <- pd62.clean


# grep("20201119_SYPRO_t0_CNECLMG1199_SYPROoSYTO62_C.nec_highN_SYPRO_t0_1.fcs",sampleNames(flowsetSYPRO_trf_subs_all.atd))
psytobpclean <- ggcyto(hierarchfsBODIPYKP.clean.atd,aes(x=`RL1-H`))
# psypro + geom_density(aes(y = ..count..,fill=Timepoint)) + facet_grid(Treatment~Timepoint)
psytobpclean + geom_density(aes(fill = timepoint), bw = "SJ") +
  facet_grid(experiment ~ timepoint) +
  theme_bw() +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 270)) +
  ylab("Density") +
  geom_vline(xintercept = 10.5,
             lty = 2,
             alpha = 0.6) +
  labs_cyto("marker")

bpsytobpclean <- ggcyto(hierarchfsBODIPYKP.clean.atd,
                        aes(y = `RL1-H`, fill = timepoint))
bpsytobpclean + geom_violin(aes(x = 1), bw = "SJ") +
  facet_grid( ~ timepoint) +
  geom_hline(yintercept = 10.5,
             lty = 2,
             alpha = 0.6) +
  theme_bw() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )

bpsytobpclean + geom_boxplot() +
  facet_grid(experiment ~ timepoint) +
  geom_hline(yintercept = 10.5,
             lty = 2,
             alpha = 0.6) +
  theme_bw() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )

medfluointensbodipy.clean <- gs_pop_get_stats(gatingsetBODIPYKP.hier.clean,
                                        "/SYTO62+",type=pop.MFI)
openxlsx::addWorksheet(reswb,sheetName = "MedianSyto62_BODIPY_clean")
openxlsx::writeData(reswb,sheet="MedianSyto62_BODIPY_clean",
                    x = medfluointensbodipy.clean)

meanfluointenssyto62BPclean <-
  fsApply(hierarchfsBODIPYKP.clean.atd,
          function(x)
            mean(x@exprs[, "RL1-H"]))
meanfluointenssyto62BPclean.df <-
  data.frame(filename = rownames(meanfluointenssyto62BPclean),
             mean_fluo_syto62 = meanfluointenssyto62BPclean)

openxlsx::addWorksheet(reswb,sheetName = "MeanSyto62_BODIPY_clean")
openxlsx::writeData(reswb,sheet="MeanSyto62_BODIPY_clean",
                    x = meanfluointenssyto62BPclean.df)
openxlsx::saveWorkbook(reswb,file = "Results/FCM_results.xlsx",overwrite = TRUE)
```

# Discussion